<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光熱費請求管理アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f0f2f5;
            font-size: 14px;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; max-height: 90vh; }
        
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 1rem 1.5rem; border-radius: 0.5rem; color: white;
            opacity: 0; transition: opacity 0.3s, transform 0.3s;
            transform: translateY(20px); z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.warning { background-color: #ffc107; color: #212529; }
        
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="app-container" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">光熱費請求管理</h1>
            <p class="text-xs text-gray-500 mt-1">社員寮の光熱費を一元管理します。</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-2"></p>
        </header>

        <div class="flex items-center justify-start mb-6 space-x-4">
            <button id="addRoomBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-plus mr-2"></i>部屋を追加
            </button>
            <button id="exportExcelBtn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transition duration-300 flex items-center opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-file-excel mr-2"></i>Excelに出力
            </button>
        </div>
        
        <div id="alert-container" class="mb-6 space-y-2"></div>

        <div id="room-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

        <div id="loading" class="text-center py-10">
            <p class="text-gray-500">データを読み込み中...</p>
        </div>
    </div>

    <div id="billHistoryModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 p-6 m-4 modal overflow-y-auto">
             <div class="flex justify-between items-center mb-4 pb-4 border-b">
                 <h2 id="billHistoryModalTitle" class="text-xl font-bold">請求履歴</h2>
                 <button id="closeBillHistoryModal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
             </div>
             <div id="billHistoryContainer" class="max-h-[60vh] overflow-y-auto space-y-2 p-1">
             </div>
        </div>
    </div>
    
    <div id="roomModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop"><div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 p-6 m-4 modal overflow-y-auto"><form id="roomForm"><input type="hidden" id="roomId"><h2 id="modalTitle" class="text-xl font-bold mb-6"></h2><fieldset class="border p-4 rounded-lg mb-4"><legend class="text-base font-semibold px-2">基本情報</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="roomNumber" class="block text-xs font-medium text-gray-700">部屋番号</label><input type="text" id="roomNumber" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label for="tenantName" class="block text-xs font-medium text-gray-700">使用者名</label><input type="text" id="tenantName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label for="phoneNumber" class="block text-xs font-medium text-gray-700">電話番号</label><input type="tel" id="phoneNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div class="md:col-span-2"><label for="address" class="block text-xs font-medium text-gray-700">住所</label><input type="text" id="address" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div></div></fieldset><fieldset class="border p-4 rounded-lg mb-4"><legend class="text-base font-semibold px-2">インフラ情報</legend><div class="space-y-6"><div class="p-3 bg-gray-50 rounded-md"><h4 class="font-semibold text-yellow-500 mb-2">電気</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="text-xs">お客様番号</label><input type="text" id="electricCustomerNumber" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">支払方法</label><select id="electricPaymentMethod" class="mt-1 w-full border-gray-300 rounded-md text-xs"><option value="コンビニ決済">コンビニ決済</option><option value="口座振替">口座振替</option></select></div><div><label class="text-xs">利用開始日</label><input type="date" id="electricStartDate" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">登録状況</label><input type="text" id="electricStatus" placeholder="例：手続き完了" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div></div></div><div class="p-3 bg-gray-50 rounded-md"><h4 class="font-semibold text-red-500 mb-2">ガス</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="text-xs">お客様番号</label><input type="text" id="gasCustomerNumber" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">支払方法</label><select id="gasPaymentMethod" class="mt-1 w-full border-gray-300 rounded-md text-xs"><option value="コンビニ決済">コンビニ決済</option><option value="口座振替">口座振替</option></select></div><div><label class="text-xs">利用開始日</label><input type="date" id="gasStartDate" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">登録状況</label><input type="text" id="gasStatus" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div></div></div><div class="p-3 bg-gray-50 rounded-md"><h4 class="font-semibold text-blue-500 mb-2">水道</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="text-xs">お客様番号</label><input type="text" id="waterCustomerNumber" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">支払方法</label><select id="waterPaymentMethod" class="mt-1 w-full border-gray-300 rounded-md text-xs"><option value="コンビニ決済">コンビニ決済</option><option value="口座振替">口座振替</option></select></div><div><label class="text-xs">利用開始日</label><input type="date" id="waterStartDate" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">登録状況</label><input type="text" id="waterStatus" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div></div></div><div class="p-3 bg-gray-50 rounded-md"><h4 class="font-semibold text-green-500 mb-2">インターネット</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="text-xs">お客様番号</label><input type="text" id="internetCustomerNumber" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">支払方法</label><select id="internetPaymentMethod" class="mt-1 w-full border-gray-300 rounded-md text-xs"><option value="コンビニ決済">コンビニ決済</option><option value="口座振替">口座振替</option></select></div><div><label class="text-xs">利用開始日</label><input type="date" id="internetStartDate" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div><div><label class="text-xs">登録状況</label><input type="text" id="internetStatus" class="mt-1 w-full border-gray-300 rounded-md text-xs"></div></div></div></div></fieldset><fieldset class="border p-4 rounded-lg"><legend class="text-base font-semibold px-2">ログイン情報メモ</legend><textarea id="loginNotes" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="各システムのID、パスワードなどのメモにご利用ください。"></textarea></fieldset><div class="flex justify-end mt-6 space-x-3"><button type="button" id="cancelRoomModal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">キャンセル</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">保存</button></div></form></div></div>

    <div id="billModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop"><div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 p-6 m-4 modal"><form id="billForm"><input type="hidden" id="billRoomId"><input type="hidden" id="billId"><h2 id="billModalTitle" class="text-xl font-bold mb-2">請求書の追加</h2><p class="mb-6 text-gray-600">部屋番号: <span id="billModalRoomNumber" class="font-semibold"></span></p><div class="space-y-4"><div><label for="billUtilityType" class="block text-xs font-medium text-gray-700">種別</label><select id="billUtilityType" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"><option value="electric">電気</option><option value="gas">ガス</option><option value="water">水道</option><option value="internet">インターネット</option></select></div><div><label for="billMonth" class="block text-xs font-medium text-gray-700">対象年月</label><input type="month" id="billMonth" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label for="billAmount" class="block text-xs font-medium text-gray-700">請求金額 (円)</label><input type="number" id="billAmount" required placeholder="例: 5000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label for="billPeriod" class="block text-xs font-medium text-gray-700">請求期間</label><input type="text" id="billPeriod" placeholder="例: 2024/05/01 - 2024/05/31" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div></div><div class="flex justify-end mt-6 space-x-3"><button type="button" id="cancelBillModal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">キャンセル</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">登録</button></div></form></div></div>

    <div id="confirmDeleteModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop"><div class="bg-white rounded-lg shadow-xl w-11/12 sm:w-1/3 p-6 m-4 modal"><h2 class="text-xl font-bold mb-4">確認</h2><p id="confirmDeleteMessage"></p><div class="flex justify-end mt-6 space-x-3"><button id="cancelDelete" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">キャンセル</button><button id="confirmDelete" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">削除</button></div></div></div>

    <div id="toast-container"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot,
            collection, query, where, getDocs, writeBatch, serverTimestamp, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CẤU HÌNH FIREBASE (QUAN TRỌNG) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFfsZmlXD87LE37In1iUA0rezWfHa2Bgo",
            authDomain: "quan-ly-hoa-don-dien-nuoc.firebaseapp.com",
            databaseURL: "https://quan-ly-hoa-don-dien-nuoc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quan-ly-hoa-don-dien-nuoc",
            storageBucket: "quan-ly-hoa-don-dien-nuoc.firebasestorage.app",
            messagingSenderId: "336770304005",
            appId: "1:336770304005:web:496ae0775f7c39deac746c"
        };

        // --- Biến toàn cục ---
        let dataService;
        let authReady = false;
        let allRoomsData = [], allBillsData = [];

        // --- DOM Elements ---
        const roomList = document.getElementById('room-list');
        const loading = document.getElementById('loading');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const addRoomBtn = document.getElementById('addRoomBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const billHistoryModal = document.getElementById('billHistoryModal');
        const roomForm = document.getElementById('roomForm');
        const billForm = document.getElementById('billForm');

        // --- Hàm tiện ích UI ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function translateUtility(type) {
            const map = { electric: '電気', gas: 'ガス', water: '水道', internet: 'インターネット' };
            return map[type] || type;
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
        }

        // --- Logic render UI ---
        function renderUI(rooms = [], bills = []) {
            // Dòng này không cần thiết vì dữ liệu toàn cục đã được cập nhật trong listener
            // allRoomsData = rooms;
            // allBillsData = bills;
            roomList.innerHTML = '';
            loading.style.display = 'none';

            if (rooms.length === 0) {
                loading.innerHTML = '<p class="text-gray-500 text-center col-span-full">まだ部屋が登録されていません。最初の部屋を追加しましょう。</p>';
                loading.style.display = 'block';
                return;
            }

            const billsByRoom = new Map();
            bills.forEach(bill => {
                if (!billsByRoom.has(bill.roomId)) billsByRoom.set(bill.roomId, []);
                billsByRoom.get(bill.roomId).push(bill);
            });
            
            const sortedRooms = [...rooms].sort((a, b) => (a.roomNumber || '').localeCompare(b.roomNumber || '', undefined, { numeric: true }));

            // ▼▼▼ PHẦN ĐƯỢC SỬA DUY NHẤT ▼▼▼
            sortedRooms.forEach(room => {
                const roomBills = billsByRoom.get(room.id) || [];
                const latestBills = new Map();
                
                // Sửa lỗi: Kiểm tra nếu `room.utilities` không tồn tại thì dùng đối tượng rỗng
                const utilities = room.utilities || {}; 

                ['electric', 'gas', 'water', 'internet'].forEach(type => {
                    const typeBills = roomBills.filter(b => b.utilityType === type)
                                                .sort((a,b) => (b.year * 100 + b.month) - (a.year * 100 + a.month));
                    if (typeBills.length > 0) latestBills.set(type, typeBills[0]);
                });
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg p-4 flex flex-col justify-between transition-shadow hover:shadow-xl';
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-bold text-blue-800">${room.roomNumber}</h3>
                                <p class="text-sm text-gray-600">${room.tenantName || '使用者未設定'}</p>
                                <p class="text-xs text-gray-500 mt-1"><i class="fas fa-phone-alt fa-fw mr-1"></i>${room.phoneNumber || '未設定'}</p>
                                <p class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt fa-fw mr-1"></i>${room.address || '住所未設定'}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${room.id}" class="edit-room-btn text-gray-500 hover:text-blue-600 transition"><i class="fas fa-edit"></i></button>
                                <button data-id="${room.id}" data-name="${room.roomNumber}" class="delete-room-btn text-gray-500 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2 mb-3 text-xs">
                            ${createUtilityRow('electric', '電気', 'yellow', utilities.electric, latestBills.get('electric'))}
                            ${createUtilityRow('gas', 'ガス', 'red', utilities.gas, latestBills.get('gas'))}
                            ${createUtilityRow('water', '水道', 'blue', utilities.water, latestBills.get('water'))}
                            ${createUtilityRow('internet', 'インターネット', 'green', utilities.internet, latestBills.get('internet'))}
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex space-x-2">
                        <button data-id="${room.id}" data-name="${room.roomNumber}" class="add-bill-btn w-1/2 bg-green-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-green-600 transition text-xs">請求書追加</button>
                        <button data-id="${room.id}" data-name="${room.roomNumber}" class="view-history-btn w-1/2 bg-gray-200 text-gray-800 font-semibold py-2 px-3 rounded-md hover:bg-gray-300 transition text-xs">請求履歴</button>
                    </div>`;
                roomList.appendChild(card);
            });
            // ▲▲▲ KẾT THÚC PHẦN SỬA ĐỔI ▲▲▲

            checkAlerts(rooms, billsByRoom);
            attachRoomActionListeners();
        }

        function createUtilityRow(type, name, color, utilityInfo, latestBill) {
             const billInfo = latestBill ? `${latestBill.year}/${String(latestBill.month).padStart(2, '0')}: ${latestBill.amount.toLocaleString()}円` : '<span class="text-gray-400">請求書未登録</span>';
             const iconMap = { electric: 'fa-bolt', gas: 'fa-fire-flame-simple', water: 'fa-tint', internet: 'fa-wifi' };
             // Thêm `utilityInfo?` để an toàn hơn nữa
             return `<div class="flex items-center justify-between"><div class="flex items-center"><i class="fas ${iconMap[type]} text-${color}-500 w-5 text-center"></i><span class="font-medium ml-2">${name}</span><span class="text-xs text-gray-500 ml-3">( ${utilityInfo?.paymentMethod || '未設定'} )</span></div><div class="text-right">${billInfo}</div></div>`;
        }

        function checkAlerts(rooms, billsByRoom) {
             const alertContainer = document.getElementById('alert-container');
             alertContainer.innerHTML = '';
             const today = new Date();
             const currentYear = today.getFullYear();
             const currentMonth = today.getMonth() + 1;
             const currentDay = today.getDate();
             if (currentDay < 30) return;
             rooms.forEach(room => {
                 const roomBills = billsByRoom.get(room.id) || [];
                 ['electric', 'gas', 'water', 'internet'].forEach(type => {
                     const hasBill = roomBills.some(b => b.utilityType === type && b.year === currentYear && b.month === currentMonth);
                     if (!hasBill) {
                         const alertEl = document.createElement('div');
                         alertEl.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md text-sm';
                         alertEl.innerHTML = `<p class="font-bold">注意</p><p>部屋「${room.roomNumber}」の${currentYear}/${currentMonth}分の${translateUtility(type)}の請求書がまだ入力されていません。</p>`;
                         alertContainer.appendChild(alertEl);
                     }
                 });
             });
        }
        
        // --- Dịch vụ dữ liệu (Data Service Abstraction) ---
        const localStorageService = {
            _getRooms: () => JSON.parse(localStorage.getItem('rooms') || '[]'),
            _getBills: () => JSON.parse(localStorage.getItem('bills') || '[]'),
            _saveRooms: (rooms) => localStorage.setItem('rooms', JSON.stringify(rooms)),
            _saveBills: (bills) => localStorage.setItem('bills', JSON.stringify(bills)),
            async init() { showToast('オフラインモードで実行中。データは同期されません。', 'warning'); userIdDisplay.textContent = 'オフラインモード'; this.loadData(); },
            loadData() { renderUI(this._getRooms(), this._getBills()); },
            async getRoom(id) { return this._getRooms().find(r => r.id === id); },
            async saveRoom(roomData) { let rooms = this._getRooms(); if (roomData.id) { rooms = rooms.map(r => r.id === roomData.id ? { ...r, ...roomData } : r); } else { roomData.id = `local_${Date.now()}`; rooms.push(roomData); } this._saveRooms(rooms); this.loadData(); },
            async deleteRoom(roomId) { let rooms = this._getRooms().filter(r => r.id !== roomId); let bills = this._getBills().filter(b => b.roomId !== roomId); this._saveRooms(rooms); this._saveBills(bills); this.loadData(); },
            async getBill(billId) { return this._getBills().find(b => b.id === billId); },
            async saveBill(billData) {
                let bills = this._getBills();
                if (billData.id) { // Update
                    bills = bills.map(b => b.id === billData.id ? { ...b, ...billData } : b);
                } else { // Add new
                    const hasDuplicate = bills.some(b => b.roomId === billData.roomId && b.utilityType === billData.utilityType && b.year === billData.year && b.month === billData.month);
                    if (hasDuplicate) {
                        showToast(`この部屋の${billData.year}/${String(billData.month).padStart(2, '0')}分の${translateUtility(billData.utilityType)}請求書は既に入力されています。`, 'warning');
                        return false;
                    }
                    billData.id = `local_bill_${Date.now()}`;
                    bills.push(billData);
                }
                this._saveBills(bills);
                this.loadData();
                return true;
            }
        };

        const firestoreService = {
            db: null, auth: null, userId: null, unsubscribeRooms: null, unsubscribeBills: null,
            async init() { const app = initializeApp(firebaseConfig); this.db = getFirestore(app); this.auth = getAuth(app); await setPersistence(this.auth, browserLocalPersistence); return new Promise((resolve, reject) => { onAuthStateChanged(this.auth, async (user) => { if (user) { this.userId = user.uid; userIdDisplay.textContent = `UserID: ${this.userId}`; this.loadData(); resolve(); } else { try { await signInAnonymously(this.auth); } catch (error) { console.error("Authentication failed:", error); reject(error); } } }); }); },
            
            loadData() {
                if (!this.userId) return;
                const updateUI = () => {
                    renderUI(allRoomsData, allBillsData);
                };
                const roomsQuery = query(collection(this.db, `users/${this.userId}/rooms`));
                if (this.unsubscribeRooms) this.unsubscribeRooms();
                this.unsubscribeRooms = onSnapshot(roomsQuery, (snapshot) => {
                    allRoomsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                }, (error) => {
                    console.error("Error listening to rooms: ", error);
                    showToast('部屋データの読み込みに失敗しました。権限を確認してください。', 'error');
                });
                const billsQuery = query(collection(this.db, `users/${this.userId}/bills`));
                if (this.unsubscribeBills) this.unsubscribeBills();
                this.unsubscribeBills = onSnapshot(billsQuery, (snapshot) => {
                    allBillsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                }, (error) => {
                    console.error("Error listening to bills: ", error);
                });
            },

            async getRoom(id) { const docRef = doc(this.db, `users/${this.userId}/rooms`, id); const docSnap = await getDoc(docRef); return docSnap.exists() ? {id: docSnap.id, ...docSnap.data()} : null; },
            async saveRoom(roomData) { const collectionRef = collection(this.db, `users/${this.userId}/rooms`); if (roomData.id) { const docRef = doc(collectionRef, roomData.id); await setDoc(docRef, { ...roomData, updatedAt: serverTimestamp() }, { merge: true }); } else { await addDoc(collectionRef, { ...roomData, createdAt: serverTimestamp() }); } },
            async deleteRoom(roomId) { const batch = writeBatch(this.db); const billsQuery = query(collection(this.db, `users/${this.userId}/bills`), where("roomId", "==", roomId)); const billsSnapshot = await getDocs(billsQuery); billsSnapshot.forEach(doc => batch.delete(doc.ref)); const roomRef = doc(this.db, `users/${this.userId}/rooms`, roomId); batch.delete(roomRef); await batch.commit(); },
            async getBill(billId) { const docRef = doc(this.db, `users/${this.userId}/bills`, billId); const docSnap = await getDoc(docRef); return docSnap.exists() ? {id: docSnap.id, ...docSnap.data()} : null; },
            async saveBill(billData) {
                const billsRef = collection(this.db, `users/${this.userId}/bills`);
                if (billData.id) {
                    const docRef = doc(billsRef, billData.id);
                    const { id, ...dataToUpdate } = billData;
                    await updateDoc(docRef, dataToUpdate);
                } else {
                    const q = query(billsRef, where("roomId", "==", billData.roomId), where("utilityType", "==", billData.utilityType), where("year", "==", billData.year), where("month", "==", billData.month));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showToast(`この部屋の${billData.year}/${String(billData.month).padStart(2, '0')}分の${translateUtility(billData.utilityType)}請求書は既に入力されています。`, 'warning');
                        return false;
                    }
                    await addDoc(billsRef, { ...billData, enteredAt: serverTimestamp() });
                }
                return true;
            }
        };

        // --- Event Listeners ---
        function attachRoomActionListeners() {
            document.querySelectorAll('.edit-room-btn').forEach(btn => btn.addEventListener('click', handleEditRoom));
            document.querySelectorAll('.delete-room-btn').forEach(btn => btn.addEventListener('click', handleDeleteRoom));
            document.querySelectorAll('.add-bill-btn').forEach(btn => btn.addEventListener('click', handleAddBill));
            document.querySelectorAll('.view-history-btn').forEach(btn => btn.addEventListener('click', handleViewBillHistory));
        }

        function attachHistoryModalListeners(container) {
            container.querySelectorAll('.edit-bill-btn').forEach(btn => btn.addEventListener('click', handleEditBill));
             container.querySelectorAll('.month-header').forEach(header => {
                 header.addEventListener('click', (e) => {
                     if (e.target.closest('.edit-bill-btn')) return;
                     const details = header.nextElementSibling;
                     const icon = header.querySelector('i');
                     details.classList.toggle('hidden');
                     icon.classList.toggle('rotate-180');
                 });
             });
        }
        
        exportExcelBtn.addEventListener('click', () => {
            if (!allRoomsData || allRoomsData.length === 0) {
                showToast('エクスポートするデータがありません。', 'warning'); return;
            }
            const dataToExport = allBillsData.map(bill => {
                const room = allRoomsData.find(r => r.id === bill.roomId) || {};
                return {
                    "部屋番号": room.roomNumber, "使用者名": room.tenantName, "電話番号": room.phoneNumber, "住所": room.address,
                    "請求種別": translateUtility(bill.utilityType), "対象年月": `${bill.year}/${String(bill.month).padStart(2,'0')}`, "請求期間": bill.period || '', "請求金額": bill.amount,
                    "電気_お客様番号": room.utilities?.electric?.customerNumber, "ガス_お客様番号": room.utilities?.gas?.customerNumber,
                    "水道_お客様番号": room.utilities?.water?.customerNumber, "ネット_お客様番号": room.utilities?.internet?.customerNumber,
                    "ログインメモ": room.loginNotes
                };
            });
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "光熱費請求");
            XLSX.writeFile(workbook, "光熱費請求管理.xlsx");
            showToast('Excelファイルにエクスポートしました。');
        });

        addRoomBtn.addEventListener('click', () => { roomForm.reset(); document.getElementById('roomId').value = ''; document.getElementById('modalTitle').textContent = '部屋情報の登録'; openModal(document.getElementById('roomModal')); });
        
        roomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('roomId').value;
            const roomData = { roomNumber: document.getElementById('roomNumber').value, tenantName: document.getElementById('tenantName').value, phoneNumber: document.getElementById('phoneNumber').value, address: document.getElementById('address').value, loginNotes: document.getElementById('loginNotes').value, utilities: { electric: {}, gas: {}, water: {}, internet: {} } };
            if(id) roomData.id = id;
            ['electric', 'gas', 'water', 'internet'].forEach(type => {
                roomData.utilities[type] = {
                    customerNumber: document.getElementById(`${type}CustomerNumber`).value,
                    paymentMethod: document.getElementById(`${type}PaymentMethod`).value,
                    startDate: document.getElementById(`${type}StartDate`).value,
                    status: document.getElementById(`${type}Status`).value
                };
            });
            await dataService.saveRoom(roomData);
            showToast(id ? '部屋情報を更新しました。' : '新しい部屋を追加しました。');
            closeModal(document.getElementById('roomModal'));
        });

        billForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('billId').value;
            
            const amountInput = document.getElementById('billAmount');
            const amountValue = parseInt(amountInput.value, 10);

            if (isNaN(amountValue) || amountValue < 0) {
                showToast('有効な請求金額を入力してください。', 'error');
                amountInput.focus();
                return;
            }

            const monthInput = document.getElementById('billMonth');
            if (!monthInput.value) {
                showToast('対象年月を選択してください。', 'error');
                monthInput.focus();
                return;
            }
            
            const billData = {
                roomId: document.getElementById('billRoomId').value,
                utilityType: document.getElementById('billUtilityType').value,
                year: parseInt(monthInput.value.split('-')[0]),
                month: parseInt(monthInput.value.split('-')[1]),
                amount: amountValue,
                period: document.getElementById('billPeriod').value
            };
            if (id) billData.id = id;

            const success = await dataService.saveBill(billData);

            if (success) {
                showToast(id ? '請求書を更新しました。' : '請求書を登録しました。');
                closeModal(document.getElementById('billModal'));
            }
        });

        async function handleEditRoom(e) { const id = e.currentTarget.dataset.id; const data = await dataService.getRoom(id); if (data) { document.getElementById('roomId').value = id; document.getElementById('modalTitle').textContent = '部屋情報の編集'; document.getElementById('roomNumber').value = data.roomNumber; document.getElementById('tenantName').value = data.tenantName; document.getElementById('phoneNumber').value = data.phoneNumber; document.getElementById('address').value = data.address || ''; document.getElementById('loginNotes').value = data.loginNotes || ''; ['electric', 'gas', 'water', 'internet'].forEach(type => { const utility = (data.utilities || {})[type] || {}; document.getElementById(`${type}CustomerNumber`).value = utility.customerNumber || ''; document.getElementById(`${type}PaymentMethod`).value = utility.paymentMethod || 'コンビニ決済'; document.getElementById(`${type}StartDate`).value = utility.startDate || ''; document.getElementById(`${type}Status`).value = utility.status || ''; }); openModal(document.getElementById('roomModal')); } }
        
        function handleDeleteRoom(e) { const id = e.currentTarget.dataset.id; const name = e.currentTarget.dataset.name; document.getElementById('confirmDeleteMessage').textContent = `部屋「${name}」を本当に削除しますか？関連する請求書もすべて削除されます。`; openModal(document.getElementById('confirmDeleteModal')); const confirmBtn = document.getElementById('confirmDelete'); const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.addEventListener('click', async () => { await dataService.deleteRoom(id); showToast('部屋を正常に削除しました。'); closeModal(document.getElementById('confirmDeleteModal')); }); }
        
        function handleAddBill(e) { const id = e.currentTarget.dataset.id; const name = e.currentTarget.dataset.name; billForm.reset(); document.getElementById('billId').value = ''; document.getElementById('billModalTitle').textContent = '請求書の追加'; document.getElementById('billRoomId').value = id; document.getElementById('billModalRoomNumber').textContent = name; const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth() - 1); document.getElementById('billMonth').value = lastMonth.toISOString().slice(0, 7); openModal(document.getElementById('billModal')); }
        
        async function handleEditBill(e) {
            const billId = e.currentTarget.dataset.billId;
            const bill = await dataService.getBill(billId);
            if (bill) {
                const room = await dataService.getRoom(bill.roomId);
                closeModal(document.getElementById('billHistoryModal'));
                document.getElementById('billId').value = bill.id;
                document.getElementById('billRoomId').value = bill.roomId;
                document.getElementById('billModalTitle').textContent = '請求書の編集';
                document.getElementById('billModalRoomNumber').textContent = room?.roomNumber || 'N/A';
                document.getElementById('billUtilityType').value = bill.utilityType;
                document.getElementById('billMonth').value = `${bill.year}-${String(bill.month).padStart(2, '0')}`;
                document.getElementById('billAmount').value = bill.amount;
                document.getElementById('billPeriod').value = bill.period || '';
                openModal(document.getElementById('billModal'));
            } else {
                showToast('請求書データが見つかりません。', 'error');
            }
        }
        
        function handleViewBillHistory(e) {
            const roomId = e.currentTarget.dataset.id;
            const roomName = e.currentTarget.dataset.name;
            const billsForRoom = allBillsData.filter(bill => bill.roomId === roomId);
            const groupedBills = new Map();
            billsForRoom.forEach(bill => {
                const monthKey = `${bill.year}-${String(bill.month).padStart(2, '0')}`;
                if (!groupedBills.has(monthKey)) groupedBills.set(monthKey, { total: 0, details: [] });
                const monthData = groupedBills.get(monthKey);
                monthData.total += bill.amount;
                monthData.details.push({ id: bill.id, utilityType: bill.utilityType, amount: bill.amount, period: bill.period });
            });
            const container = document.getElementById('billHistoryContainer');
            container.innerHTML = '';
            document.getElementById('billHistoryModalTitle').textContent = `請求履歴 (${roomName})`;
            if (groupedBills.size === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">この部屋には請求履歴がありません。</p>`;
            } else {
                const sortedMonths = Array.from(groupedBills.keys()).sort().reverse();
                sortedMonths.forEach(monthKey => {
                    const monthData = groupedBills.get(monthKey);
                    const [year, month] = monthKey.split('-');
                    const monthHtml = `
                         <div class="bg-gray-50 rounded-lg shadow-sm">
                              <div class="month-header flex justify-between items-center font-bold p-3 cursor-pointer">
                                  <p class="text-base text-gray-800">${year}/${parseInt(month, 10)}</p>
                                  <div class="flex items-center">
                                      <p class="text-base text-blue-600 mr-4">合計: ${monthData.total.toLocaleString()} 円</p>
                                      <i class="fas fa-chevron-down transition-transform"></i>
                                  </div>
                              </div>
                              <ul class="month-details p-3 pt-0 hidden border-t border-gray-200">
                                  ${monthData.details.map(detail => `
                                      <li class="flex justify-between items-start text-xs py-2">
                                          <div>
                                              <div class="flex items-center">
                                                  <span class="text-gray-600">${translateUtility(detail.utilityType)}:</span>
                                                  <span class="font-medium ml-2">${detail.amount.toLocaleString()} 円</span>
                                              </div>
                                              ${detail.period ? `<p class="text-gray-400 text-xs mt-1 ml-1">期間: ${detail.period}</p>` : ''}
                                          </div>
                                          <button data-bill-id="${detail.id}" class="edit-bill-btn text-blue-600 hover:text-blue-800 font-semibold py-1 px-2 rounded-md self-center">編集</button>
                                      </li>
                                  `).join('')}
                              </ul>
                         </div>
                    `;
                    container.innerHTML += monthHtml;
                });
            }
            attachHistoryModalListeners(container);
            openModal(document.getElementById('billHistoryModal'));
        }

        document.getElementById('cancelRoomModal').addEventListener('click', () => closeModal(document.getElementById('roomModal')));
        document.getElementById('cancelBillModal').addEventListener('click', () => closeModal(document.getElementById('billModal')));
        document.getElementById('cancelDelete').addEventListener('click', () => closeModal(document.getElementById('confirmDeleteModal')));
        document.getElementById('closeBillHistoryModal').addEventListener('click', () => closeModal(document.getElementById('billHistoryModal')));

        // --- Hàm khởi tạo chính ---
        async function main() {
            if (firebaseConfig && firebaseConfig.apiKey) {
                try {
                    dataService = firestoreService;
                    await dataService.init();
                    showToast('オンラインモードで接続しました。', 'success');
                } catch (e) {
                    console.warn("Could not initialize Firestore, falling back to LocalStorage.", e.message);
                    dataService = localStorageService;
                    await dataService.init();
                }
            } else {
                dataService = localStorageService;
                await dataService.init();
            }
            authReady = true;
            addRoomBtn.disabled = false;
            addRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            exportExcelBtn.disabled = false;
            exportExcelBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            loading.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
